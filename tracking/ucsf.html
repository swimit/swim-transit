<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>InSync Realtime Map</title>
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100%;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script src="https://repo.swim.it/swim/recon-0.3.9.js"></script>
    <script src="https://repo.swim.it/swim/swim-client-0.4.6.js"></script>
    <script>
      //var organizationName = window.location.hash || 'Home';
      var lat = 37.7521;
      var lon = -122.4411;
      var map;
      //var client = require('swim-client-js');
	  //var swim = new client.Client();
      var host = swim.host('ws://localhost:9090');
      //var region = host.node('transit/norcal');
      var organization = host.node('agency/ucsf')
      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: lat, lng: lon},
          zoom: 12,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        });
        var devices = organization.downlink()
          .lane('agency/vehicles')
          .onEvent(function (event) {
            var device = event.body;
            console.log(recon.stringify(device));
            if (recon.tag(device) === '@remove') {
              this.markers[device.id].setMap(null);
              return;
            }
            var lat = Number(device.latitude);
            var lng = Number(device.longitude);
            console.log(lat);
            console.log(lng);
            if (!lat || !lng) {
              return;
            }
            if (this.markers[device.id]) {
              this.markers[device.id].setPosition({lat: lat, lng: lng});
            } else {
              this.markers[device.id] = new google.maps.Marker({
                map: map,
                position: {lat: lat, lng: lng},
                title: device.deviceName,
                icon: 'http://city.swim.it/images/bus-primary-tiny.svg'
              });
              var infowindow = new google.maps.InfoWindow({
              	content: "Vehicle " + device.id
              })
              google.maps.event.addListener(this.markers[device.id], 'click', function() {
              	infowindow.open(map, this);
              });
            }
          })
          .keepAlive(true)
          .syncMap();
        devices.markers = {};
      }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBI-Gz_lh3-rKXFwlpElD7pInA60U-iK0c&libraries=visualization&callback=initMap"></script>
  </body>
</html>