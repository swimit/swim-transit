<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>AC Transit Tracking App</title>
    <link rel="shortcut icon" href="https://www.swim-iot.com/hubfs/swim_favicon_16x@2x.png?t=1497901337094">
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100%;
      }
      #legend {
        font-family: Arial, sans-serif;
        background: #fff;
        padding: 10px;
        margin: 10px;
        border: 3px solid #000;
        height: 90px;
        width: 170px;
      }
    </style>
</head>
<body>
<div id="map"></div>
<div id="legend"><h3>Agency Stats</h3></div>
<script src="https://repo.swim.it/swim/recon-0.5.0.js"></script>
<script src="https://repo.swim.it/swim/swim-client-0.5.1.js"></script>
<script>
      var lat = 37.7320518;
      var lon = -122.1499481;
      var map;
      var host = Swim.host('ws://localhost:9090');
      var organization = host.node('extAgency/actransit')
      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: lat, lng: lon},
          zoom: 10,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        });
        var legend = document.getElementById('legend');
        var total = document.createElement('div');
        total.innerHTML = "<p>Total Number of Vehicles: </p>";
        legend.appendChild(total);
        var average = document.createElement('div');
        average.innerHTML = "<p>Average Speed (Km/Hr): </p>";
        map.controls[google.maps.ControlPosition.RIGHT_TOP].push(legend);
        legend.appendChild(average);
        var counts = organization.downlinkValue()
        	.lane('agency/count')
        	.onEvent(function (event) {
        		var count = event;
        		total.innerHTML = "<p>Total Number of Vehicles: " + Recon.stringify(count) +"</p>";
                legend.appendChild(total);
        		})
        	.open()
        var speed = organization.downlinkValue()
        	.lane('agency/speed')
        	.onEvent(function (event) {
        		var speed = event;
        		average.innerHTML = "<p>Average Speed (Km/Hr): " + Number(Recon.stringify(speed)).toFixed(2) +"</p>";
                legend.appendChild(average);
        		})
        	.open()
        var devices = organization.downlinkMap()
          .lane('agency/vehicles')
          .onEvent(function (event) {
            var device = event
            if (Recon.tag(device) === '@remove') {
              devices.markers[device.id].setMap(null);
              return;
            }
            var lat = Number(device.latitude);
            var lng = Number(device.longitude);
            if (!lat || !lng) {
              return;
            }
            if (devices.markers[device.id]) {
              devices.markers[device.id].setPosition({lat: lat, lng: lng});
              google.maps.event.clearInstanceListeners(devices.markers[device.id]);
            } else {
              devices.markers[device.id] = new google.maps.Marker({
                map: map,
                position: {lat: lat, lng: lng},
                title: device.deviceName,
                icon: 'http://city.swim.it/images/bus-primary-tiny.svg'
              });
            }
            var infowindow = new google.maps.InfoWindow({
              	content: "Vehicle: " + device.id + " Agency: " + device.agency + " Route: " +device.routeId + " Speed: " + device.speed + " Km/Hr"
              })
              google.maps.event.addListener(devices.markers[device.id], 'click', function() {
              	infowindow.open(map, this);
              });
          })
          .open()
        devices.markers = {};
      }
    </script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBI-Gz_lh3-rKXFwlpElD7pInA60U-iK0c&libraries=visualization&callback=initMap"></script>
</body>
</html>